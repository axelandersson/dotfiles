#!/usr/bin/perl -w

use strict;
use CLI;

my $options = CLI::options("server|s=s", "domain|d=s", "username|u=s");

my $server = $options->{"server"} || $ENV{"AD_SERVER"};
my $domain = $options->{"domain"} || $ENV{"AD_DOMAIN"};
my $username = $options->{"username"} || $ENV{"AD_USERNAME"};
my $targetusername = shift @ARGV;

CLI::usage("[--server|-s <server>] [--domain|-d <domain>] [--username|-u <username>] <username>") if $options->{"help"} || !$domain || !$username || !$server || !$targetusername;

#my $password = CLI::askwithoutecho("Password for $domain\\$username");
my $password = "Qwe88,7x";

adwhois($server, $domain, $username, $password, $targetusername);



sub adwhois {
    my $server = shift;
    my $domain = shift;
    my $username = shift;
    my $password = shift;
    my $targetusername = shift;

    my $base = join(",", map { "dc=$_" } split(/\./, $server));
    my @output = CLI::run(["ldapsearch", "-x", "-y", "/dev/stdin", "-h", $server, "-D", "$domain\\$username", "-b", $base, "-s", "sub", "(sAMAccountName=$targetusername)"], { "rawinput" => $password, "assertonerror" => 1 });

    foreach my $line (@output) {
        if($line =~ /^(cn|title|physicalDeliveryOfficeName|department|company|employeeID|manager):/) {
            println $line;
        }
    }
}
